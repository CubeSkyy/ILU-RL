# Experiment 0x04

The goal is to show convergency wrt Q-tables in intersection scenario.

# MDP
	
- states: (s0, c0, s1, c1)
- actions: (0, 1)
- reward: -max((s\*, s\*) - (s0, s1), 0) \* (c0, c1)
- transition_matrix: null
- gamma: 0.99

 Where 
 
- sP -> [0, 22) average speed on phase P P=0, 1
- cP -> [0, 18] average count on phase P P=0, 1
- s\* -> 10 target velocity

# Experiment

Experiments are carried out by running the following incantations

```
> time python models/train.py intersection -t 180000 \
			-s 1 -i 1 -r 0 -e 0 -p 1 -W 0 -S 30 -L 60
```

## Settings

- Network: intersection.
- InFlows: `lane`.
- Edges Distribution: ['-238059328', '309265401', '383432312', '309265401']
- Phase Splits: 60x30, 54x36, 50x40, 45x45 sec.
- Instances: 12.
- Time Steps: 180000 sec. or 2000 cycles.
- Reward: `target velocity`.

	 
## Observation
 
- Departures from every phase.
- Uniform departure times.
- Uniform departure velocities.

## Learning
	
- Algorithm: Q-Learning.
- Upper confidence interval.
- c = 10.
- alpha = 50%.

## Discretization

A discretization scheme is needed by the choice of state value function estimation.

- sP <= 2.28 		-> 0
- 2.28 < sP < 3.11	-> 1
- sP >= 3.11		-> 2
- cP <= 8.56 		-> 0
- 26.58 < cP < 26.58	-> 1
- cP >= 26.58		-> 2

## Changes

- **alpha = 50%**
- **target velocity = 10**
- More instances from 6 to 12
- More phase splits: 60x30, 54x36, 50x40, 45x45 from 60x30
- cycles: 2000 from 5000

# Findings

The following figures are generated by running:

```
> python analysis/rewards.py cycles -t evaluate
```

##  Rewards 60x30

![Average rewards per cycles](60x30_train_rewards_cycles.png)

## Speeds and Counts 60x30

![Left axis shows average speeds, right axis shows the average counts over the 12 experiments during 2000 cycles.](60x30_train_velsvehs_cycles.png)

##  Optimal 60x30

![Ratio of the time the agent selects the optimal action](60x30_train_optimal_cycles.png)

## Scatter 60x30

The scatter plot is generated by running:

```
> python analysis/scatter.py
```

The figure shows the observation spaces perceived by the agent.
	 
- phase#0 blue dots relate to the pairs (s0, c0).
- phase#1 red dots relate to the pairs (s1, c1).
- target velocity on purple.
- gray lines are state separators;

![This scatter plot shows two clouds of points on the speed vs counts space those related from phase 0 and 1](60x30_scatter.png)

##  Rewards 54x36

![Average rewards per cycles](54x36_train_rewards_cycles.png)

## Speeds and Counts 54x36

![Left axis shows average speeds, right axis shows the average counts over the 12 experiments during 2000 cycles.](54x36_train_velsvehs_cycles.png)

##  Optimal 54x36

![Ratio of the time the agent selects the optimal action](54x36_train_optimal_cycles.png)

## Scatter 54x36

The scatter plot is generated by running:

```
> python analysis/scatter.py
```

The figure shows the observation spaces perceived by the agent.
	 
- phase#0 blue dots relate to the pairs (s0, c0).
- phase#1 red dots relate to the pairs (s1, c1).
- target velocity on purple.
- gray lines are state separators;

![This scatter plot shows two clouds of points on the speed vs counts space those related from phase 0 and 1](54x36_scatter.png)


##  Rewards 50x30

![Average rewards per cycles](50x30_train_rewards_cycles.png)

## Speeds and Counts 50x30

![Left axis shows average speeds, right axis shows the average counts over the 12 experiments during 2000 cycles.](50x30_train_velsvehs_cycles.png)

##  Optimal 50x30

![Ratio of the time the agent selects the optimal action](50x30_train_optimal_cycles.png)

## Scatter 50x30

The scatter plot is generated by running:

```
> python analysis/scatter.py
```

The figure shows the observation spaces perceived by the agent.
	 
- phase#0 blue dots relate to the pairs (s0, c0).
- phase#1 red dots relate to the pairs (s1, c1).
- target velocity on purple.
- gray lines are state separators;

![This scatter plot shows two clouds of points on the speed vs counts space those related from phase 0 and 1](50x30_scatter.png)


##  Rewards 45x45

![Average rewards per cycles](45x45_train_rewards_cycles.png)

## Speeds and Counts 45x45

![Left axis shows average speeds, right axis shows the average counts over the 12 experiments during 2000 cycles.](45x45_train_velsvehs_cycles.png)

##  Optimal 45x45

![Ratio of the time the agent selects the optimal action](45x45_train_optimal_cycles.png)

## Scatter 45x45

The scatter plot is generated by running:

```
> python analysis/scatter.py
```

The figure shows the observation spaces perceived by the agent.
	 
- phase#0 blue dots relate to the pairs (s0, c0).
- phase#1 red dots relate to the pairs (s1, c1).
- target velocity on purple.
- gray lines are state separators;

![This scatter plot shows two clouds of points on the speed vs counts space those related from phase 0 and 1](45x45_scatter.png)


